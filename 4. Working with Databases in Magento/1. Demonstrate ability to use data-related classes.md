# Demonstrate ability to use data-related classes

## Describe repositories and data API classes.

[Magento - Searching with Repositories](http://devdocs.magento.com/guides/v2.2/extension-dev-guide/searching-with-repositories.html)

Magento 2.2 changed repository getList approach. Before you applied filters, sorts and pagination manually
right in the `getList` method itself.

Magento 2.2 takes this boilerplate routine off developer's shoulders. Just call `collectionProcessor.process()`.

[Api\SearchCriteria\CollectionProcessorInterface](https://github.com/magento/magento2/blob/2.2-develop/lib/internal/Magento/Framework/Api/SearchCriteria/CollectionProcessorInterface.php)
[Api\SearchCriteria\CollectionProcessor](https://github.com/magento/magento2/blob/2.2-develop/lib/internal/Magento/Framework/Api/SearchCriteria/CollectionProcessor.php)
- this is a composite and default preference

Default collection processors - always applied:
- [FilterProcessor](https://github.com/magento/magento2/blob/2.2-develop/lib/internal/Magento/Framework/Api/SearchCriteria/CollectionProcessor/FilterProcessor.php#L45):
  * DI configurable *custom filters* by field name. E.g. store_id
  * *field mapping*
  * addFilterGroupToCollection when no custom filter defined - like before
- [SortingProcessor](https://github.com/magento/magento2/blob/2.2-develop/lib/internal/Magento/Framework/Api/SearchCriteria/CollectionProcessor/SortingProcessor.php#L45):
  * DI configurable *default orders*
  * *field mapping*
- [PaginationProcessor](https://github.com/magento/magento2/blob/2.2-develop/lib/internal/Magento/Framework/Api/SearchCriteria/CollectionProcessor/PaginationProcessor.php):
  * setCurPage, setPageSize

Additional processors - add them via DI for your EAV repository:
- EAV [FilterProcessor](https://github.com/magento/magento2/blob/2.2-develop/app/code/Magento/Eav/Model/Api/SearchCriteria/CollectionProcessor/FilterProcessor.php#L45)
  * same as normal filter processor, slightly different condition apply
  * *field mapping*
  * *custom filters*
- [JoinProcessor](https://github.com/magento/magento2/blob/2.2-develop/lib/internal/Magento/Framework/Api/SearchCriteria/CollectionProcessor/JoinProcessor.php) - used only in tax rule repository

For EAV, inject virtual collection processor `Magento\Eav\Model\Api\SearchCriteria\CollectionProcessor`

## How do you obtain an object or set of objects from the database using a repository?

*Loading single object*

While model->load() is deprecated, your repository is the place to work with resource model.
- create empty model object with factory
- call `resourceModel.load($object)` just like `model->load()` would.

Example:
```xml
public function getById($blockId)
{
    $block = $this->blockFactory->create();
    $this->resource->load($block, $blockId);
    if (!$block->getId()) {
        throw new NoSuchEntityException(__('CMS Block with id "%1" does not exist.', $blockId));
    }
    return $block;
}
```


## How do you configure and create a SearchCriteria instance using the builder?

- Api\SearchCriteriaBuilder
- Api\SearchCriteria

To build a searchCriteria object, use $searchCriteriaBuilder. You don't need a factory, this type is declared as `shared="false"`. Once `create()` method is caled, its data empties.


## How do you use Data/Api classes?

Api/:
- repository interfaces
- put operational interfaces - helpers etc. business logic API
- implementation lies in models
- usually available via WebAPI

Api/Data - entity container interfaces, usually extend AbstractSimpleObject

In your repository, you should return data interfaces. Some models directly implement data interfaces (catalog product), while others are completely separate - there's customer model and customer data object.

Example of converting collection models to data objects in customer repository:
```xml
$customers = [];
/** @var \Magento\Customer\Model\Customer $customerModel */
foreach ($collection as $customerModel) {
    $customers[] = $customerModel->getDataModel();
}
$searchResults->setItems($customers);
```

`getDataModel` is not a standard method, you implement it yourself.

```xml
public function getDataModel()
{
    // ...
    $customerDataObject = $this->customerDataFactory->create();
    $this->dataObjectHelper->populateWithArray(
        $customerDataObject,
        $customerData, // $customer->getData()
        \Magento\Customer\Api\Data\CustomerInterface::class
    );
    // ...
    return $customerDataObject;
}
```

## populateWithArray helper

Based on interface, calls all SETTERS with given data to fill data object

[Api\DataObjectHelper::populateWithArray](https://github.com/magento/magento2/blob/2.2-develop/lib/internal/Magento/Framework/Api/DataObjectHelper.php#L80)
- calls data object SETTERS `set*`, `setIs*` with given raw data
- handles `custom_attributes` - data object.setCustomAttribute


## buildOutputDataArray

Based on given interface, calls all GETTERS to make resulting data array.

[Reflection\DataObjectProcessor::buildOutputDataArray](https://github.com/magento/magento2/blob/2.2-develop/lib/internal/Magento/Framework/Reflection/DataObjectProcessor.php#L72):
- \Magento\Framework\Reflection\MethodsMap::getMethodsMap - method name and getter return types
- filter only getters: is..., has..., get...
- get data using interface getter, e.g. $object->getSku() - based on Interface definition
- deduce field name by getter name, e.g. 'sku'
- process custom_attributes \Magento\Framework\Reflection\CustomAttributesProcessor::buildOutputDataArray
- process extension_attributes \Magento\Framework\Reflection\ExtensionAttributesProcessor::buildOutputDataArray
- process return object: build return value objects with their return type annotation
- process return array: cast each element to type, e.g. int[] => (int) each value
- cast element to type

- Describe how to create and register new entities.[mageplaza](https://www.mageplaza.com/devdocs/how-create-eav-attribute-magento-2.html),[techjeffyu](http://techjeffyu.com/blog/magento-2-creating-new-eav-entity-and-model),[excellencemagentoblog](http://excellencemagentoblog.com/blog/2018/04/17/add-customer-attributes-programmatically-in-magento-2/)

- How do you add a new table to the database? [devdocs](https://devdocs.magento.com/videos/fundamentals/add-a-new-table-to-database/),[bsscommerce](https://bsscommerce.com/confluence/how-to-create-insert-data-into-the-table-in-magento-2/)

- Describe the entity load and save process. [belvg](https://belvg.com/blog/eav-load-and-save-processes-in-magento-2.html)

- Describe how to extend existing entities.
[exam-notes](https://github.com/magento-notes/magento2-exam-notes/blob/master/5.%20Using%20the%20Entity-Attribute-Value%20-EAV-%20Model/2.%20Demonstrate%20ability%20to%20use%20EAV%20entity%20load%20and%20save.md) , [magestore](https://blog.magestore.com/entity-attribute-value-in-magento/)

-What mechanisms are available to extend existing classes, for example by
adding a new attribute, a new field in the database, or a new related entity? [devdocs](https://devdocs.magento.com/guides/v2.3/extension-dev-guide/extension_attributes/adding-attributes.html),[devdocs2](https://devdocs.magento.com/guides/v2.3/extension-dev-guide/attributes.html),[hellomagento2](https://www.hellomagento2.com/extension-attributes/)

- Describe how to filter, sort & specify the selected values for collections and repositories?
[devdocs](https://devdocs.magento.com/guides/v2.3/extension-dev-guide/searching-with-repositories.html),[webkul](https://webkul.com/blog/how-to-use-search-criteria-in-custom-module/)

- How do you select a subset of records from the database? [belvg](https://belvg.com/blog/magento-2-database-group-operations.html),[stackexchange](https://magento.stackexchange.com/questions/109426/magento-2-how-to-select-fetch-data-from-database)

- Describe the database abstraction layer for Magento.
[devdocs](https://devdocs.magento.com/guides/v2.3/architecture/archi_perspectives/service_layer.html),[belvg](https://belvg.com/blog/database-in-magento-2-models-resource-models-and-collections.html), [medium](https://medium.com/@matthewhaworth1/understanding-data-persistence-in-magento-2-d3fefafc4f2e)

- What type of exceptions does the database layer throw? [belvg](https://belvg.com/blog/magento-2-architecture-how-is-it-used-in-magento-2-application.html),

- What additional functionality does Magento provide over Zend_Adapter?
[stackexchange](https://magento.stackexchange.com/questions/33981/magento-2-and-zend-framework-2), [mageplaza](https://www.mageplaza.com/kb/there-has-been-error-processing-your-request-magento-2.html)
